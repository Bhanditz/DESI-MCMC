%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%% ICML 2015 EXAMPLE LATEX SUBMISSION FILE %%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Use the following line _only_ if you're still using LaTeX 2.09.
%\documentstyle[icml2015,epsf,natbib]{article}
% If you rely on Latex2e packages, like most moden people use this:
\documentclass{article}

% use Times
\usepackage{times}
% For figures
\usepackage{graphicx} % more modern
%\usepackage{epsfig} % less modern
\usepackage{subfigure} 
\usepackage{amsmath,amsfonts,amssymb,bbm}
\usepackage{tikz}
\usetikzlibrary{fit,positioning}
\usepackage{todonotes}

% For citations
\usepackage{natbib}

% For algorithms
\usepackage{algorithm}
\usepackage{algorithmic}

% As of 2011, we use the hyperref package to produce hyperlinks in the
% resulting PDF.  If this breaks your system, please commend out the
% following usepackage line and replace \usepackage{icml2015} with
% \usepackage[nohyperref]{icml2015} above.
\usepackage{hyperref}

% Packages hyperref and algorithmic misbehave sometimes.  We can fix
% this with the following command.
\newcommand{\theHalgorithm}{\arabic{algorithm}}
\DeclareMathOperator{\Tr}{Tr}
\newcommand{\R}{\mathbbm{R}}
\newcommand{\mba}{\mathbf{a}}
\newcommand{\mbb}{\mathbf{b}}
\newcommand{\mbx}{\mathbf{x}}
\newcommand{\mbxt}{\tilde{\mathbf{x}}}
\newcommand{\Sigmat}{\tilde{\Sigma}}
\newcommand{\mbz}{\mathbf{z}}
\newcommand{\mbw}{\mathbf{w}}
\newcommand{\mcN}{\mathcal{N}}
\newcommand{\mcP}{\mathcal{P}}
\newcommand{\mcX}{\mathcal{X}}
\newcommand{\eps}{\epsilon}
\newcommand{\trans}{\intercal}
\newcommand{\Ut}{\tilde{U}}
\DeclareMathOperator*{\argmax}{arg\,max}
\newcommand{\angstrom}{\textup{\AA}}
\newcommand{\red}[1]{\textcolor{red}{[TODO: #1]}}
\newcommand{\Nspec}{{N_{\text{spec}}}}
\newcommand{\Nphoto}{{N_{\text{photo}}}}

% Employ the following version of the ``usepackage'' statement for
% submitting the draft version of the paper for review.  This will set
% the note in the first column to ``Under review.  Do not distribute.''
\usepackage{icml2015} 

% Employ this version of the ``usepackage'' statement after the paper has
% been accepted, when creating the final version.  This will set the
% note in the first column to ``Proceedings of the...''
%\usepackage[accepted]{icml2015}


% The \icmltitle you define below is probably too long as a header.
% Therefore, a short form for the running title is supplied here:
\icmltitlerunning{Model of Quasar Spectroscopy}

\begin{document} 

\twocolumn[
\icmltitle{A Stochastic Process Model of Quasar Spectral Energy Distributions}
% It is OKAY to include author information, even for blind
% submissions: the style file will automatically remove it for you
% unless you've provided the [accepted] option to the icml2015
% package.
\icmlauthor{Andrew Miller}{acm@seas.harvard.edu}
\icmlauthor{Albert Wu}{awu@college.harvard.edu}
\icmladdress{School of Engineering and Applied Sciences, Harvard University}
\icmlauthor{Jeffrey Regier}{jeff@stat.berkeley.edu}
\icmlauthor{Jon McAuliffe}{jon@stat.berkeley.edu}
\icmladdress{Department of Statistics, University of California, Berkeley}
\icmlauthor{Dustin Lang}{dstn@cmu.edu}
\icmladdress{McWilliams Center for Cosmology, Carnegie Mellon University}
\icmlauthor{Prabhat}{prabhat@lbl.gov}
\icmlauthor{David Schlegel}{djschlegel@lbl.gov}
\icmladdress{Lawrence Berkeley National Laboratory, 
             1 Cyclotron Road, Berkeley, CA, 94720 USA}
\icmlauthor{Ryan Adams}{rpa@seas.harvard.edu}
\icmladdress{School of Engineering and Applied Sciences, Harvard University}
%
% You may provide any keywords that you 
% find helpful for describing your paper; these are used to populate 
% the "keywords" metadata in the PDF but will not be shown in the document
\icmlkeywords{astronomy, Gaussian process, Bayesian statistics, multi-resolution, hierarchical model}

\vskip 0.3 in
]

\begin{abstract} 
We describe a method for combining two disparate sources of astronomical data, spectroscopy and photometry, which carry information about sources of light (e.g., stars, galaxies, and quasars) at extremely different resolutions. 
Our model treats the spectral energy distribution (SED) of the radiation of a source as a latent variable, hierarchically generating both photometric and spectroscopic observations.  
Furthermore, we view the problem of SED inference as a density estimation problem, placing a flexible nonparametric prior over the SED of a light source that admits a physically interpretable decomposition and allows us to tractably perform Bayesian inference using Markov chain Monte Carlo (MCMC).  
We use our model to predict the distribution of the redshift of a quasar from five-band (low-resolution) photometric data, the so called ``photo-z'' problem. 
Our method shows that tools from machine learning and Bayesian statistics allow us to leverage multiple resolutions of information to make accurate predictions with well-characterized uncertainties.  
%Our method leverages a small number of existing examples of high resolution quasar spectra with known redshift to build a structured prior distribution over unknown spectra.  
%We describe a fully generative model that combines information from a large dataset of high resolution spectroscopic measurements with a small number of broadband photometric observations, and we use it to measure the redshift of quasars from photometry, the ``photo-z'' problem.  
\end{abstract} 

\section{Introduction}
Enormous amounts of astronomical data are collected by a range of instruments at multiple resolutions, providing information about billions of sources of light in the observable universe~\cite{kent1994sdss, martin2005galex}.  
Among these data are measurements of the spectral energy distribution (SED) of a source.  
The SED describes the distribution of energy radiated by a source over the spectrum of wavelengths or energy levels. \todo{what are energy levels?}  
For intuition, the SED of a star at around 5,800 $K$ (like our sun) radiates most of its energy in the 4,000 $\angstrom$ to 7,000 $\angstrom$ range, which corresponds roughly to the range of visible light.  
However, stars tend to have simple distributions (well-modeled by Planck's law), whereas other objects, such as galaxies and quasars, can have much more complicated SEDs.  
The SED of a source is an object of interest because it conveys information about the physical properties of the particular object, including type of source, effective temperature, distance to earth, and redshift. 

Measurements of SEDs, however, are produced by instruments at widely varying resolutions.  
Spectroscopic data describe a source's SED in finer detail than broadband photometric data.  For example, the Baryonic Oscillation Spectroscopic Survey \cite{dawson2013baryon} measures SED samples at over four thousand wavelengths between 3,500 and 10,500 $\angstrom$.
In contrast, the photometry from the Sloan Digital Sky Survey (SDSS)~\cite{kent1994sdss} collects pixel-level fluxes in the relatively broad $u,g,r,i,$ and $z$ bands.  
Photometric preprocessing models can then aggregate pixel information into five band-specific fluxes and their uncertainties \cite{luptonsdss}.  
These measurements reflect the weighted average response over a large swath of the wavelength spectrum. 
The two methods of spectral information collection are graphically compared in Figure~\ref{fig:filters}. 

%------ SDSS Filter Figure -----------------------------------------------
\begin{figure*}[ht]
\vskip 0in
\begin{center}
\centerline{\includegraphics[width=2\columnwidth]{../figs/quasar_spectrum_sdss_filters}}
\vskip -0.18in
\caption{%
Example of a BOSS-measured quasar SED with SDSS \emph{ugriz} band filters, $S_{b}(\lambda)$, $b \in \{u, g, r, i, z\}$, overlaid.
Spectroscopic measurements include noisy samples at thousands of wavelengths, where as SDSS photometric fluxes reflect the (weighted) response over a large range of wavelengths.}
\label{fig:filters}
\end{center}
\vskip -0.28in
\end{figure*} 
%--------------------------------------------------------------------------

Despite carrying less information, broadband photometry is more widely available and exists for a larger number of sources than spectroscopic measurements. 
This work develops a method for extracting information from observations of light sources by \emph{jointly} modeling spectroscopic and photometric data.  
In particular, we use our model to measure the redshift of quasars for which we only have photometric observations.  
Redshift is a phenomenon in which the observed SED of a source of light is stretched toward longer (redder) wavelengths.
This effect is due to a combination of a high radial velocity with respect to the observer and the expansion of the universe (termed \emph{cosmological redshift})~\cite{hogg1999distance, harrison1993redshift}.  
Quasars, or quasi-stellar radio sources, are extremely distant and energetic sources of electromagnetic radiation that can exhibit high redshift~\cite{silk1997quasars}.  
Accurate estimates and uncertainties of redshift measurements from photometry have the potential to guide the use of higher resolution instruments to study sources of interest.  
Furthermore, accurate photometric models can aid the automation of identifying source types and estimating physical characteristics of faintly observed sources in large photometric surveys \cite{regier2015}.  

Our model jointly describes high-resolution spectroscopic data and low-resolution photometric observations of quasars in terms of their latent SEDs, apparent brightnesses, and redshifts. 
Representing a quasar's SED as a latent random measure, we describe a Bayesian inference procedure to compute the marginal probability distribution of a quasar's redshift given observed photometric fluxes and their uncertainties.  
The following section provides relevant application and statistical background, as well as related work on the ``photo-z'' problem.
Section~\ref{sec:model} describes our probabilistic model of SEDs and broadband photometric measurements.
Section~\ref{sec:inference} outlines our MCMC-based inference method for efficiently computing statistics of the posterior distribution.
Section~\ref{sec:experiments} presents redshift and SED predictions from photometric measurements, among other model summaries.
We conclude with a discussion and an outline of directions for future work.  

%------ example of obs vs rest frame data --------------------------------------
\begin{figure*}[ht]
\vskip 0in
\begin{center}
\centerline{\includegraphics[width=1.9\columnwidth]{../figs/quasar_redshift_obs_frame}}
\centerline{\includegraphics[width=1.9\columnwidth]{../figs/quasar_redshift_rest_frame}}
\vskip -0.18in
\caption{%
\todo[inline]{Sorta wish the x-axes lined up here, but I suppose it would squish too much.}
Spectroscopic measurements of multiple quasars at different redshifts, $z$.
The top graphic depicts the sample spectrograph in the observation frame, intuitively thought of as ``stretched'' by a factor $(1+z)$.
The lower figure depicts the ``de-redshifted'' version of the same quasar spectra.
This effectively squashes observations, and reconstructs the quasar spectra as it would be seen in the quasar's rest frame.
One salient feature of this operation is the alignment of large peaks around 1,250 $\angstrom$. }
\label{fig:frames}
\end{center}
\vskip -0.28in
\end{figure*} 
%--------------------------------------------------------------------------------


\section{Background}
\label{sec:background}
The SED of a source describes the distribution of the energy it radiates as a function of wavelength.  
For example, most stars are well-modeled as ideal black-body radiators, as their SED is well-described by a parametric form given by Planck's law. 
Quasars, on the other hand, have a complicated SED characterized by some salient features, such the Lyman-$\alpha$ forest, which refers to a phenomenon that causes ultraviolet light emissions from quasars to appear as visible light (which is not blocked by the atmosphere) to observers on Earth~\cite{weinberg2003lymanalpha}.

One of the most important and interesting properties of quasars (and galaxies) conveyed by the SED is redshift. 
Redshift affects our observation of SEDs by ``stretching'' the wavelengths, ${\lambda \in \Lambda}$, of the quasar's \emph{rest-frame} SED, skewing toward longer (redder) wavelengths.
Denoting the \emph{rest-frame} SED of a quasar~$n$ as a function,~${f_n^{(\text{rest})} : \Lambda \rightarrow \R_+}$, the effect of redshift on the \emph{observation-frame} SED is summarized by the relationship 
\begin{align}
  f_n^{(\text{obs})}(\lambda) &\propto f_n^{(\text{rest})}(\lambda \cdot (1 + z_n)) \, .
\end{align}
Some observed quasar spectra and their ``de-redshifted'' rest frame spectra are depicted in Figure~\ref{fig:frames}.

\subsection{Gaussian processes}
Due to the complicated shape of SEDs, we use Gaussian processes to flexibly encode our prior beliefs about the structure and shape of quasar SEDs. 
A Gaussian process (GP) is a stochastic process, ${f: \mathcal{X} \rightarrow \R}$, such that any finite collection of random variables, ${f(x_1),\dots, f(x_N) \in \R}$, is distributed according to a multivariate normal distribution.  
GPs are frequently used as priors over unknown functions, $f$, where the random variables $f(x_1), \dots, f(x_N)$ correspond to evaluations of the function at inputs ${x_1, \dots, x_N \in \mcX}$.  
The prior covariance between any two outputs, $f(x_i)$ and $f(x_j)$, encodes prior beliefs about the function~$f$; carefully chosen covariance functions can encode beliefs about a wide range of properties, including differentiability, smoothness, and periodicity.  

Throughout this paper we will use the the Mat\'{e}rn \cite{Matern1986spatial} covariance function
\begin{align}
  k_{\text{Matern}}(r)
    &= \frac{2^{1-\nu}}{\Gamma(\nu)} 
       \left( \frac{\sqrt{\nu} r}{\ell} \right) ^\nu
       K_\nu\left( \frac{\sqrt{2\nu} r}{\ell}\right)
\end{align}
where ${r = |x_1 - x_2|}$.  The parameter $\nu$ controls the smoothness and $\ell$ is the length scale of the function.  
We choose the Mat\'{e}rn covariance function for its ability to trade off between smooth and flexible sample paths.  
Because this covariance is strictly a function of the distance between two points in the space $\mcX$, it is said to be stationary. 
See \citet{rasmussen2006gaussian} for a thorough treatment of Gaussian processes in machine learning. 

\subsection{Related work}
Many machine learning and statistical methods have been applied to the ``photo-$z$'' problem. The review by \citet{walcher2011fitting} divides ``photo-$z$'' methods into two categories, empirical and template-fitting.  Empirical methods are often discriminative, regression-based approaches, whereas template-fitting methods are often SED model-based approaches.  

A recently proposed empirical method uses a multi-layer perceptron with a combination of photometric datasets, including SDSS, 
%SDSS, UKIDSS, and WISE photometric fluxes datasets, 
to compute a regression function for redshift \cite{brescia2013photometric}. 
This method, while efficient and accurate in mean error, does not characterize the uncertainty of the estimated redshift, nor does it admit any physically interpretable estimate of the SED and quasar type.  

Template-based approaches use information derived from spectroscopy to assist redshift predictions.  
\citet{budavari2001photometric} and \citet{richards2001photometric} present a clustering algorithm for reconstructing quasar SEDs from photometric observations and templates derived from noisy spectroscopic measurements.  
Their method clusters quasars into individual template categories using a $K$-means-like update, relying on weighted template averages of noisy SED measurements and unique cluster assignments that do not express uncertainty over quasar ``types''. 

Instead of a pure clustering method, we use a non-negative factor analysis-type model to represent the latent structure of quasar SEDs and a continuous, low-dimensional range of quasar types.  
Furthermore, our method presents a fully probabilistic model of SEDs and a Bayesian inference procedure that integrates out uncertainty over latent variables, including quasar type and apparent brightness, to measure redshift.    

Other models blur the line between regression-based and generative models.  \citet{bovy2012photometric} develops the $XDQSOz$ method to use a large dataset of astronomical objects to simultaneously infer redshift and classify quasars.  
They model the joint distribution over object type, fluxes, and redshift.  However, their method does not model SEDs themselves, nor the SED-to-flux generative process. 
%They do this by inferring a joint distribution over object type, fluxes, and redshift. In particular, they factor this joint distribution
%into one part that describes the distribution over star brightness, which involves binning based on a single-channel flux, and
%one part that describes the distribution of relative fluxes (as compared to this channel) and the redshift. The latter distribution
%is represented by a mixture of up to 60 Gaussians. 
%However, we see that, due to the
%binning, this approach is not fully probabilistic or Bayesian.

%\citet{benitez2000bayesian} presents a thorough summary of Bayesian methods for photometric redshift estimation from spectral templates.  
%\citet{budavari2009unified} unifies template-based and regression-based
%approaches into a single probabilistic framework, distinguishing methods based on the assumptions they impose on probability distributions over photometric fluxes. 

%\red{Others to mention: }
%\cite{suzuki2006quasar} does unsupervised learning on the UV spectra of quasars using principal components analysis (PCA). Through this analysis, the authors found that 96\% of the total variance was accounted for by the first 3 spectral components. As a result, they created a classification scheme based on the first two component's coefficients that separates quasars into five different classes. This classification scheme allows researchers to understand quasars better from a qualitative perspective.
%\red{This doesn't seem that relevant. What do you think, Andy?}


%----------------------------------------------------------------------------------
%----------------------------------------------------------------------------------
%----------------------------------------------------------------------------------
\section{Model}

%--- Graphical Model ------------------------------------------
\begin{figure}
\vskip -.08in
\input{graph_model}
\vskip -.16in
\caption{%
Graphical model representation of the joint photometry and spectroscopy model. 
The left shaded variables represent spectroscopically measured samples and their variances.
The right shaded variables represent photometrically measured fluxes and their variances.
Note that ${\Nspec + \Nphoto}$ replicates of $\mathbf{w}_n, m_n$ and $z_n$ are instantiated. }
\label{fig:graphical}
\vskip -.16in
\end{figure}

\label{sec:model}
This section describes the details of our probabilistic model of spectroscopic and photometric observations.  

\subsection{Spectroscopic flux model}
The SED of a quasar is a non-negative function~${f : \Lambda \rightarrow \R^+}$, where~$\Lambda$ denotes the range of wavelengths and~$\R^+$ are non-negative real numbers.
Quasar SEDs are highly structured, and we model this structure by imposing the assumption that each SED is a convex mixture of~$K$ latent, positive basis functions (or templates). 
Following \citet{budavari2001photometric} we set ${K = 4}$. \todo{Did you try other values?}
We also note that this is the number of PCA components that have been shown to carry over 90\% of the variation of quasar spectroscopy~\citet{suzuki2006quasar}. 
This model assumes there are a small number of latent ``types'' and that each quasar can be described by a short vector of mixing weights over ``types''. \todo{Are these really types?} 
Our model specifies a quasar's \emph{rest-frame} SED as a random measure. \todo{Is this useful beyond having said it is a random positive function? Does the measure aspect of it come up?} 
We place a log-Gaussian process prior on each of these basis functions, and a \todo{what kind of prior?} prior over positive basis weights for each quasar.  

The generative procedure for quasar spectra begins with a shared basis of normalized positive SEDs that map wavelengths to positive numbers:
\begin{align}
  \beta_k(\cdot) &\sim \mathcal{GP}(0, K_\theta),\; k=1, \dots, K\\
  B_k(\cdot) &= \frac{\exp(\beta_k(\cdot))}{\int_\Lambda \exp(\beta_k(\lambda))\, d\lambda}   \, ,
\end{align}
where $K_{\theta}$ is the Mat\'{e}rn kernel and $B_k$ is the exponentiated and normalized version of $\beta_k$. For each quasar $n$
\begin{align}
  \mathbf{w}_n &\sim p(\mathbf{w}) \, , \text{ s.t. } \sum_{w_k} w_k = 1  \\
  m_n  &\sim p(m) \, , \text{ s.t. } m_n > 0 \\
  z_n &\sim p(z)
\end{align}
where $\mathbf{w}_n$ mixes over the latent types, $m_n$ is the apparent brightness,~$z_n$ is the quasar's redshift, and distributions~$p(\mathbf{w})$,~$p(m)$, and~$p(z)$ are generic priors. \todo{generic prior?}
The latent normalized SED is then constructed via
\begin{align}
  f^{(\text{rest})}_n(\cdot) &= \sum_{k} w_{n,k} B_k(\cdot)
  \label{eqn:restsed}
\end{align}
and we define the unnormalized spectral radiance~${\tilde f^{(\text{rest})}_n(\cdot) \equiv m_n \cdot f^{(\text{rest})}_n(\cdot)}$. \todo{What is spectral radiance?}
Each positive SED basis function,~$B_k$ is normalized to integrate to one, and each quasar's weight vector~$\mathbf{w}_n$ also sums to one.
This allows us to interpret the~$f^{(\text{rest})}_n(\cdot)$ function as a density, scaled by $m_n$. \todo{It's a density if it is differentiable, but only probability densities have to integrate to one.  Is there a value in calling it a density here?}

For each quasar with spectroscopic data, we observe noisy samples of the redshifted and scaled spectral energy distribution at a grid of $P$ wavelengths ${\lambda \in \{\lambda_1, \dots, \lambda_P \}}$.
For quasar $n$, our \emph{observation frame} samples are conditionally distributed as
\begin{align}
  x_{n, \lambda} 
    &\sim \mathcal{N}\left( \frac{1}{(1 + z_n)} \tilde f_n^{(\text{rest})}( \lambda \cdot (1 + z_n) ), \sigma_{n,\lambda}^2 \right)
    \label{eq:spec} 
\end{align}
\todo{Where does the $1+z_n$ denom come from?}
where $\sigma_{n, \lambda}^2$ is known measurement variance from the instruments used to make the observations. 
The BOSS spectra (and our rest-frame basis) are stored in units ${10^{-17} \cdot \text{erg} \cdot \text{cm}^{-2} \cdot \text{s}^{-1} \cdot \angstrom^{-1}}$.  

\subsection{Photometric flux model }
Photometric data summarize the amount of energy observed over a large swath of the wavelength spectrum. 
Roughly, a photometric flux measures (proportionally) the number of photons hitting the instrument's lens over the duration of an exposure, filtered by a band-specific sensitivity curve. 
We will express measurements of flux in nanomaggies~\cite{sdssnanomaggies}, a linear unit of flux. 

Photometric fluxes and measurement error derived from broadband imagery have been computed directly from pixels \cite{luptonsdss}.  
For each quasar $n$, SDSS photometric data are measured in five bands, ${b \in \{u,g,r,i,z\}}$, yielding a vector of five flux values and their variances,~$\mathbf{y}_n$ and~$\tau^2_{n, b}$.  
Each band, $b$, measures photon observations at each wavelength in proportion to a known filter sensitivity, $S_{b}(\lambda)$. 
The filter sensitivities for the SDSS $ugriz$ bands are depicted in Figure~\ref{fig:filters}, with an example observation frame quasar SED overlaid.  
The actual measured fluxes can be computed by integrating the full object's spectrum,~${m_n \cdot f_n^{(\text{obs})}(\lambda)}$ against the filters.
For a band~${b \in \{u, g, r, i, z \}}$
\begin{align}
  \mu_b(f_n^{(\text{rest})}, z_n) &= \int f^{(\text{obs})}_n(\lambda) \,S_b(\lambda)\, C(\lambda) \,d \lambda \,,
\end{align}
where $C(\lambda)$ is a conversion factor to go from the units of~$f_n(\lambda)$ to nanomaggies.
The factor is the following constant:
\begin{equation*}
C(\lambda) = 10^{(48.6-2.5\times 17+22.5)/2.5}
\end{equation*}
\todo{Why doesn't the right hand side have a $\lambda$?}
The values in the expression above correspond to arbitrary zero-points and constants used in astronomical units: $48.6$ is a zero-point for an astronomical measurement called AB magnitude, $17$ is used to match fluxes which are in units of $10^{-17}$ ergs and $22.5$ and $2.5$ are constants used to convert from logarithmic to linear units of brightness.

 We use $\mu_b$ to represent the full function from a rest spectrum and red shift to a band-specific flux.
 The results of this projection onto SDSS bands are modeled as independent Gaussian random variables with known variance
\begin{align}
  y_{n,b}\, |\, f_n^{(\text{rest})}, z_n &\sim \mathcal{N}( \mu_b(f_n^{(\text{rest})}, z_n), \tau^2_{n,b} ) \, .
\end{align}
Conditioned on the basis, ${B = \{B_k\}}$, we can represent $f_n^{(\text{rest})}$ with a low-dimensional vector.
Note that~$f_n^{(\text{rest})}$ is a function of~${\mathbf{w}_n, z_n, m_n}$, and $B$~(see Equation~\ref{eqn:restsed}), so we can think of $\mu_b$ as a function of~${\mathbf{w}_n, z_n, m_n}$, and~$B$.
We overload notation, and re-write the conditional likelihood of photometric observations as
\begin{align}
    y_{n,b} \,|\, \mathbf{w}_n, z_n, m_n, B &\sim \mathcal{N}( \mu_b(\mathbf{w}_n, z_n, m_n, B), \tau^2_{n,b} ) \, .
   \label{eq:phot}
\end{align}
Intuitively, what gives us statistical traction in inferring the posterior distribution over $z_n$ is the structure learned in the latent basis $B$, i.e., the features that correspond to distinguishing bumps and dips in the SED.

\subsection{Joint model}
Given a sample of $\Nspec$ noisy full spectra and their sample locations, ${\mathbf{X} \equiv \{\mathbf{x}_n, \lambda^{(\text{obs})}_n \}}$, and a set of~$\Nphoto$ photometric fluxes,~${\mathbf{Y} \equiv \{\mathbf{y}_n\}}$, our full likelihood in terms of~$\{ \mathbf{w}_n, z_n, m_n \}, \{ B_1, \dots, B_K \}$ is 
\begin{align*}
  L( \{ \mathbf{w}_n, ~&z_n, m_n \}, \{ B_1, \dots, B_K \} )  \\
    = & \prod_{n=1}^\Nspec p( \mathbf{x}_n | \mathbf{w}_n, z_n, m_n, \{ B_k \})  \\
      & \times \prod_{n=\Nspec+1}^{\Nspec + \Nphoto} p( \mathbf{y}_n | \mathbf{w}_n, z_n, m_n, \{ B_k \})\,,
\end{align*}
where the probability distribution of the first term in the product is given by Equation~\ref{eq:spec}, and the distribution for the second term in the product is given by Equation~\ref{eq:phot}.  

Whether measured spectroscopically or photometrically, all of the quasars' SEDs share the same basis, hierarchically tying them together.
This basis provides a highly compact representation of a quasar SED, and is what drives photometric redshift predictions.  
The joint distribution is depicted as a graphical model in Figure~\ref{fig:graphical}.

\paragraph{Note on priors}
We place independent priors on the components of $\mathbf{w}_n$, which is a simplifying assumption. \todo{What form of these?}
There exists rich structure even within the~${K=4}$ dimensional space specifying quasar SEDs. 
We plan to model this structure in future iterations of the model.  

% and a log-Gaussian process prior over each basis  o
%We express the joint prior distribution over weights $\mathbf{w}_n$, $\mathbf{w}_m$, and %basis $\{B_k\}$ as:
%\begin{align}
%  p( \{ \mathbf{w}_m, z_m \}, &\{ B_k \}, \{ \mathbf{w}_n, z_n \} )  \\
%    = & p(\{ B_k \}) p( \{ \mathbf{w}_m, z_m \} )  \\
%      & p( \{ \mathbf{w}_n, z_n \} | \{ \mathbf{w}_m, z_m \} ) 
%\end{align}
%where we condition the photometric weights on the spectroscopically fit weights.  

%---- TABLE, coverage --------------------------------------
\begin{table*}[t]
\caption{%
Top: mean absolute and mean absolute percentage error of photometric redshift predictions with respect to spectroscopic ``ground truth''.
Bottom: number of predicted values covered by posterior sample quantiles of varying size. }
\label{tab:error}
\vskip 0in
\begin{center}
\begin{small}
\begin{sc}
\input{../figs/error_table.tex}
\end{sc}
\end{small}
\end{center}
\vskip -0.1in
\end{table*}
%------------------------------------------------------------------------------


%----------------------------------------------------------------------------------
%----------------------------------------------------------------------------------
%----------------------------------------------------------------------------------
\section{Inference}
\label{sec:inference}
The Bayesian ``photo-z'' task requires that we compute posterior marginal distributions of $z$, integrating out $\mathbf{w}$, and $m$.  
To compute these distributions, we construct a Markov chain over the state space including $z$, $\mathbf{w}$, and $\mathbf{m}$ that leaves the target posterior distribution invariant.
We then simulate that Markov chain.  
 
For example, to compute expectations with respect to the marginal posterior distribution over quasar redshift, we will want to produce posterior samples of $z_n$, $\mathbf{w}_n$, and $B$, yielding Monte Carlo approximations
\begin{align}
  \mathbb{E}[ g(z_n) | \mathbf{y}_n, \mathbf{X} ] 
    &\approx \frac{1}{N} \sum_{i} g(z_n^{(i)}) \\
    z_n^{(i)}, \mathbf{w}_n | \mathbf{y}_n, B &\sim p(z_n, \mathbf{w}_n^{(i)} | \mathbf{y}_n, B) 
    %B^{(i)} &\sim p(B | \mathbf{X}, \mathbf{Y}) \, 
\end{align}
where $g$ represents an arbitrary function of redshift, and $N$ is the total number of Monte Carlo samples.  

For computational tractability, we compute posterior samples of approximate profile posteriors, conditioned on a maximum likelihood estimate of the basis,~$B_{\text{mle}}$. \todo{This sounds exactly like Monte Carlo EM, so we might want to call it that and provide a reference.}
However, we note that our model places a full distribution over~$B_k$; efficiently integrating out those parameters is left for future work.
The following section outlines our MCMC procedure to compute posterior samples of $\mathbf{w}_n, z_n$, and $m_n$ given the sample of spectra, $\mathbf{X}$, photometric fluxes $\mathbf{y}_{ugriz}$, and $B_{\text{mle}}$.
Note that due to analytic intractability, we numerically integrate expressions involving $\int_\Lambda f_n^{(obs)}(\lambda) d\lambda$.

%\subsection{Sampling $B$}
%To accelerate computation, we use only information present in $\mathbf{X}$ to draw samples of $B_1, \dots, B_K$.  That is, we approximate the full conditional distribution 
%\begin{align}
%  p(B_1,\dots, B_k | \mathbf{X}, \mathbf{Y}) 
%    &\approx p(B_1, \dots, B_k | \mathbf{X})
%\end{align}
%We expect this to have little effect on the distribution, as the amount of information about $B$ present in $\mathbf{X}$, the high-resolution full-spectrum data, is expected to dwarf that of $\mathbf{Y}$, the
%low-resolution bandwise fluxes.  The posterior distribution from which we sample, $p(B | \mathbf{X})$, can be written 
%\begin{align}
%  p(B | \mathbf{X}) 
%    &\propto p(\mathbf{X} | \{ \mathbf{w}_m\}_{m=1}^M, B) p(\beta) p(\mathbf{w}) \, .
%\end{align}
%We draw posterior samples using Hamiltonian Monte Carlo \cite{neal2011mcmc}, an auxiliary variable method that uses gradient information to efficiently mix.  Empirically, naive Metropolis-Hastings mixes too slowly for practical purposes. 

\subsection{Sampling $\mathbf{w}_n, m_n$, and $z_n$}
For computational reasons, we treat the inference problem for each photometrically measured quasar, $\mathbf{y}_n$, independently.
Conditioned on a basis~${B_k, k=1,\dots, K}$, our goal is to draw posterior samples of $\mathbf{w}_n$, $m_n$ and $z_n$ for each $n$.  
The unnormalized posterior can be expressed
\begin{align}
  &p(\mathbf{w}_n, m_n, z_n | \mathbf{y}_n, B) \\
  &\propto p(\mathbf{y}_n | \mathbf{w}_n, m_n, z_n, B) p(\mathbf{w}_n, m_n, z_n) \end{align}
where the left likelihood term is defined in Equation~\ref{eq:phot}.
Because the observation $\mathbf{y}_n$ can often be well explained by various redshifts and weight settings, the resulting marginal posterior, $p(z_n | \mathbf{X}, \mathbf{y}_n, B)$, are often multi-modal, with regions of near zero probability between modes.
Intuitively, this is due to the information loss in the SED-to-photometric flux integration step.

This multi-modal property is problematic for many standard MCMC techniques. 
Naive Metropolis-Hastings would have to jump between modes or travel through a region of near-zero probability, resulting in slow mixing.  
To combat this effect, we use parallel tempering \cite{brooks2011handbook}, a method that is well-suited to constructing Markov chains on multi-modal distributions.
Parallel tempering instantiates $C$ independent chains, each sampling from the target distribution raised to an inverse temperature.
Given a target distribution, $\pi(x)$, the constructed chains sample 
\begin{align}
  \pi_c(x) &\propto \pi(x)^{1/T_c}
\end{align}
where $T_c$ controls how ``hot'' (i.e.,~how close to uniform) each posterior is. 
At each iteration, swaps between chains are proposed and accepted with a standard Metropolis-Hastings acceptance probability 
\begin{align}
  \Pr(\text{accept swap } c, c') = \frac{ \pi_c(x_{c'}) \pi_{c'}(x_c) }{ \pi_c(x_c) \pi_{c'}(x_{c'}) } \, .
\end{align}
To further expedite mixing, we use Hamiltonian Monte Carlo (HMC) \cite{neal2011mcmc} for proposals within each of the parallel chains.
HMC is an auxiliary variable method that uses gradient information to generate proposals and efficiently explore the target distribution by avoiding random-walk behavior.

%----------------------------------------------------------------------------------
%----------------------------------------------------------------------------------
%----------------------------------------------------------------------------------
\section{Results}
\label{sec:experiments}
We fit our model on a sample of 400 spectroscopically measured quasars from the DR10QSO dataset \cite{paris2014sloan}, including spectroscopically confirmed redshifts in the range $z \in (.11,  5.08)$.  
We test the photometric component of our method by inferring redshifts and SEDs of sample of 2,000 spectroscopically and photometrically measured quasars with redshift in the range $z \in (.30, 5.85)$.  
The following sections outline the resulting model fit and inferred SEDs and redshifts. 
%We compute the posterior distribution by iterating our sampler over the conditional distributions described in the previous section.  For each of the 1,000 test quasars, we run 7 chains for 5000 iterations to assess mixing.  We discard the first 2,500 samples from each chain as burn-in.  The following subsections summarize and discuss model predictions and output. 


 
%----- Red Shift, spec vs photo -------------------------------------------------
\begin{figure}[t]
\vskip 0in
\centerline{\includegraphics[width=\columnwidth]{../figs/red-shift-test-predictions}}
\vskip -0.2in
\caption{Comparison of spectroscopically ($x$-axis) and photometrically ($y$-axis) measured redshifts for a held out sample of 2,000 quasars (subsampled for clarity).  Red estimates are maximal posterior modes, and grey lines display the interval consisting of samples within quantiles $[5, 95]$.  Note that this is not a representative sample - we included over 1,000 $z > 4.0$ quasars to test predictions on higher redshift quasars.}
\label{fig:vs}
\vskip -.35in
\end{figure}
%-------------------------------------------------------------------------------


%-----  -------------------------------------------------
\begin{figure*}[t]
\vskip 0in
\centerline{
\includegraphics[width=1.5\columnwidth]{../figs/quasar_plots/quasar_490_mcmc_recon.pdf}
\includegraphics[width=.57\columnwidth]{../figs/quasar_plots/quasar_490_posterior_z}
} 
\centerline{
\includegraphics[width=1.5\columnwidth]{../figs/quasar_plots/quasar_214_mcmc_recon.pdf}
\includegraphics[width=.57\columnwidth]{../figs/quasar_plots/quasar_214_posterior_z}
}
%\centerline{
%\includegraphics[width=.66\columnwidth]{../figs/quasar_plots/quasar_490_posterior_z}
%\includegraphics[width=.66\columnwidth]{../figs/quasar_plots/quasar_163_posterior_z}
%\includegraphics[width=.66\columnwidth]{../figs/quasar_plots/quasar_227_posterior_z}
%}
%\centerline{
%\includegraphics[width=.66\columnwidth]{../figs/quasar_plots/quasar_486_posterior_z}
%\includegraphics[width=.66\columnwidth]{../figs/quasar_plots/quasar_759_posterior_z}
%\includegraphics[width=.66\columnwidth]{../figs/quasar_plots/quasar_2_posterior_z}
%}
\vskip -0.2in
\caption{Left: inferred SEDs from photometric data.  The black line is a PCA-based model fit to the full spectral data.  The red line is a sample from the posterior, $f^{(obs)}_n(\lambda) | \mathbf{X}, \mathbf{y}_n, B$, which imputes the entire SED from only five flux measurements. Right: corresponding posterior predictive distributions, $p(z_n | \mathbf{X}, \mathbf{y}_n)$ for three photometrically measured quasars. The black line marks the spectroscopically confirmed redshift, and the red line marks the posterior mean $E(z_n |\mathbf{X}, \mathbf{y}_n)$. }
\label{fig:recon}
\vskip -0.1in
\end{figure*}
%---------------

%----- ------------------------------------------------
%\begin{figure*}[t]
%\vskip 0.2in
%\begin{center}
%\centerline{\includegraphics[width=2\columnwidth]{../figs/basis_samp_K_4}}
%\vskip -0.2in
%\caption{A posterior sample of the basis $\{ B_k \}_{k=1}^K$ for $K=4$.  Note the different ranges of the $x$-axis (wavelength).  Each basis function distributes its mass across different regions of the spectrum to explain different salient features of quasar spectra in the rest-frame. }
%\label{fig:basis}
%\end{center}
%\end{figure*}
%---------------

%----- -------------------------------------------------
\begin{figure*}[t]
\vskip 0in
\centerline{\includegraphics[width=2\columnwidth]{../figs/rank_4_basis}}
\centerline{\includegraphics[width=2\columnwidth]{../figs/idx_0_rank_4_reconstruction.pdf}}
%\centerline{\includegraphics[width=2\columnwidth]{../figs/idx_4_rank_4_reconstruction.pdf}}
\vskip -0.2in
\caption{Top: an estimate of the maximum likelihood of the latent templates $B = \{B_k\}_{k=1}^K$.  Note the different ranges of the $x$-axis (wavelength).  Each basis function distributes its mass across different regions of the spectrum to explain different salient features of quasar spectra in the rest-frame.  Bottom: non-negative  model reconstructions of two training-sample SEDs }
\label{fig:basis}
\vskip -.1in
\end{figure*}
%---------------

\subsection{SED Basis}
We depict the maximum likelihood estimate of $B_1, \dots, B_k$ given $\mathbf{X}$ in Figure~\ref{fig:basis}.  Our basis decomposition enjoys the benefit of physical interpretability due to our density-estimate formulation of the problem. For instance, $B_2$ contains the spike corresponding to the Lyman-$\alpha$ peak \red{verify this with dustin or david}.  Furthermore, because of the flexible nonparametric priors on $B_k$ our model automatically learned this feature from the data.  The positivity of the basis and corresponding weights distinguishes our model from PCA-based methods, which sacrifice physical interpretability.   

\subsection{Photometric measurements}
For each test quasar, we construct a 5-chain parallel tempering sampler run for 3,000 iterations.  We discard the first 1,500 samples as burn-in.  
Given posterior samples of $z_n$, we formulate two point estimates - the posterior mean and the location with highest posterior mode.  
To determine this location, we choose the sample with highest probability under a kernel density estimate of the samples with a fixed bandwidth, $\beta = .08$.  
Figure~\ref{fig:vs} compares photometric mode estimate to spectroscopic measurements and the grey lines denote posterior sample quantiles. 

We see that in general there is a strong correspondence between spectroscopically measured redshift and our posterior estimate.  In cases where the posterior point estimate is off, our distribution often covers the spectroscopically confirmed value with probability mass.
This is clear upon inspection of posterior marginal distributions that exhibit extreme multi-modal behavior.  
It is necessary to inject the model with more information to eliminate plausible hypotheses.  
This information could be in the form of another measurement (e.g.~ a new photometric band), or it could come from structured prior knowledge over the relationship between $z_n, \mathbf{w}_n$, and $m_n$.  Formulating this distribution from spectroscopically confirmed samples is left for future work.  

\paragraph{Average error and test distribution}
We use mean absolute error (MAE) and mean absolute percentage error (MAPE) to measure predictive performance.  
Table~\ref{tab:error} enumerates average prediction error using the posterior mean and the highest posterior mode, divided into nested subsets of test data.  
We also quantify average prediction error and posterior quantile interval coverage for sets of quasars with increasing redshift.  

It is worth noting that accurate redshift measurements are attainable even for quasars with redshift outside of the range of our original spectroscopic sample.  Twenty-five test quasars fall above the range of redshift in our spectroscopic sample, yet predictions for quasars above $z=5.0$ averages only 8\% error.  
Moreover, the redshift distribution of the photometric and spectroscopic in our procedure are quite different - we test on over 1,000 quasars with $z > 4.0$, whereas our spectroscopic sample sample only contains 25 such examples, yet we achieve a MAPE of only 6\%.  

It is clear that from only $400$ noisy spectroscopic measurements, our structured prior is able to accurately predict and characterize uncertainty about the redshift of photometrically measured quasars.  
Furthermore, because we are directly modeling the latent SED, our method admits a probabilistic estimate of the entire SED sample path conditioned only on observed photometric fluxes.  Figure~\ref{fig:recon} displays posterior SED samples and their corresponding redshift marginals for test-set quasars inferred from only SDSS photometric measurements.  

%\subsection{Quasar types}
%Our sampler yields posterior samples of the templates themselves; one sample is depicted in Figure~\ref{fig:basis}.  The loadings of individual quasars onto these bases intuitively describe the ``type'' of quasar being modeled.  \red{Visualize $w_n$ clusters and look at individual types. Show utility of this decomposition}.  Furthermore, because we restrict the templates to be positive functions, we obtain a more physically interpretable clustering of quasars than PCA-based methods, which will have both negative principal components and negative weights.  
%\red{Compare $z_n$ measurements to $r$ or $i$-band magnitude/flux level.  Can faint quasars be measured accurately as well?}

%----------------------------------------------------------------------------------
%----------------------------------------------------------------------------------
%----------------------------------------------------------------------------------
\section{Discussion}
We have presented a generative model to combine two sources of information at very different resolutions to form an estimate of the latent spectral energy distribution of quasars.  We described the details of the model, its implied structure, and a computationally tractable MCMC-based inference algorithm. 
Our model accurately predicted and characterized uncertainty about redshifts from only photometric observations and a small number of separate spectroscopic examples. 
%Our experiments showed the utility of our model for the task of inferring quasar redshift from photometric data, showing that we can accurately predict and characterize uncertainty about redshift values with a small number of spectroscopic examples.  
Moreover, we showed that we can make reasonable estimates of the unobserved SED itself, from which we can make inferences about other physical properties informed by the full SED.  
 
We see multiple avenues of future work.  Firstly, we can extend the model of SEDs to incorporate more expert knowledge.  One such augmentation would include a fixed collection of ``templates'' or features curated by an expert, corresponding to physical properties already known about a class of sources.  
We can also extend our model to directly incorporate photometric pixel observations. Our current specification uses the output of a photometric preprocessing step, however, a logical extension is to model photon counts at the pixel level and perform inference over a joint model. 
Because pixel appearance models conditioned on the SED of a source are well-known, we see this as a feasible next step. 

We can also extend our model to include information from different sources of photometry and spectroscopy.  Other photometric surveys measure different ranges of the spectrum, yielding more information about the underlying SED.  Methods that incorporate photometry from different sources have been shown to improve redshift estimates \cite{brescia2013photometric}.  

Lastly, we can extend our methodology to model the SED of galaxies, which can be quite complicated.  For instance, galaxy observations have spatial extent - they are not well modeled as a single point in the sky.  
Models for spatial extent have been developed and applied to photometric data \cite{hogg2013replacing, regier2015}.  
However, a galaxy's SED can vary \emph{spatially}, leading to far more complex models.    
The combination of SED and spatial appearance modeling and computationally efficient inference procedures is a promising route toward the automatic characterization of millions of sources from the enormous amounts of data available in massive photometric surveys.  

% Acknowledgements should only appear in the accepted version. 
%\section*{Acknowledgments} 
% ACM: thank dougal and scott for code
 
%\textbf{Do not} include acknowledgements in the initial version of
%the paper submitted for blind review.

%If a paper is accepted, the final camera-ready version can (and
%probably should) include acknowledgements. In this case, please
%place such acknowledgements in an unnumbered section at the
%end of the paper. Typically, this will include thanks to reviewers
%who gave useful comments, to colleagues who contributed to the ideas, 
%and to funding agencies and corporate sponsors that provided financial 
%support.  

% In the unusual situation where you want a paper to appear in the
% references without citing it in the main text, use \nocite
%\nocite{langley00}

\clearpage
\bibliography{../refs}
\bibliographystyle{icml2015}

\end{document} 


% This document was modified from the file originally made available by
% Pat Langley and Andrea Danyluk for ICML-2K. This version was
% created by Lise Getoor and Tobias Scheffer, it was slightly modified  
% from the 2010 version by Thorsten Joachims & Johannes Fuernkranz, 
% slightly modified from the 2009 version by Kiri Wagstaff and 
% Sam Roweis's 2008 version, which is slightly modified from 
% Prasad Tadepalli's 2007 version which is a lightly 
% changed version of the previous year's version by Andrew Moore, 
% which was in turn edited from those of Kristian Kersting and 
% Codrina Lauth. Alex Smola contributed to the algorithmic style files.  
